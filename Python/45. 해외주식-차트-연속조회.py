import asyncio
import ebest
from common import *
from app_keys import appkey, appsecretkey # app_keys.py 파일에 appkey, appsecretkey 변수를 정의하고 사용하세요

async def sample(api):
    keysymbol = "82TSLA" # 82TSLA: 테슬라, 82AAPL: 애플
    inputs = {
        'g3204InBlock': {
            "delaygb": "R",             # 지연구분 "R":실시간
            "keysymbol": keysymbol,     # KEY종목코드
            "exchcd": keysymbol[:2],    # 거래소코드(81: 뉴욕/아멕스, 82: 나스닥)
            "symbol": keysymbol[2:],    # 종목코드
            "gubun": "2",               # 2:일, 3:주, 4:월, 5:년
            "qrycnt": 500,              # 요청건수(최대-압축:2000비압축:500)
            "comp_yn": "N",             # 압축여부(Y:압축N:비압축)
            "sdate": "",                # 시작일자
            "edate": "",                # 종료일자
            "cts_date": "",             # 연속일자 (연속조회시 필요)
            "cts_info": "",             # 연속정보 (연속조회시 필요)
            "sujung": "Y",              # 수정주가여부(Y:적용N:비적용)
        },
    }
    response = await api.request('g3204', inputs)
    if not response: return print(f"요청 실패: {api.last_message}")

    all_data = response.body["g3204OutBlock1"]

     # 연속조회
    if response.tr_cont: # 연속조회가능
        await asyncio.sleep(1) # 1초 대기
        inputs['g3204InBlock']["cts_date"] = response.body["g3204OutBlock"]["cts_date"]
        inputs['g3204InBlock']["cts_info"] = response.body["g3204OutBlock"]["cts_info"]
        response = await api.request("g3204", inputs, tr_cont=response.tr_cont, tr_cont_key=response.tr_cont_key)
        if not response: return print(f"연속요청 실패: {api.last_message}")
        all_data = response.body["g3204OutBlock1"] + all_data

    print(all_data)
    

async def main():
    api=ebest.OpenApi()
    if not await api.login(appkey, appsecretkey):
        return print(f'연결실패: {api.last_message}')
    await sample(api)
    await api.close()

if __name__ == '__main__':
    asyncio.run(main())


# Output:
'''
Row Count = 1000
+----------+----------+----------+----------+----------+-----------+-------------+---------+-----------+----------+-----------+------+
|   date   |   open   |   high   |   low    |  close   |   volume  |    amount   | jongchk | prtt_rate | pricechk | ratevalue | sign |
+----------+----------+----------+----------+----------+-----------+-------------+---------+-----------+----------+-----------+------+
| 20210518 | 189.3144 | 198.7301 | 187.7746 | 192.6041 |  36830567 | 21440450552 |    0    |    0.00   |    0     |     0     |  2   |
| 20210519 | 184.1649 | 188.7178 | 182.3084 | 187.8012 |  39578395 | 22038253262 |    0    |    0.00   |    0     |     0     |  5   |
| 20210520 | 191.6475 | 196.2637 | 190.3376 | 195.5738 |  30821119 | 17882934825 |    0    |    0.00   |    0     |     0     |  2   |
| 20210521 | 198.6835 | 198.8734 | 193.3140 | 193.6073 |  26030595 | 15409345555 |    0    |    0.00   |    0     |     0     |  5   |
| 20210524 | 193.8473 | 204.8062 | 191.1975 | 202.1265 |  34558089 | 20726561904 |    0    |    0.00   |    0     |     0     |  2   |
| 20210525 | 202.4164 | 204.6429 | 198.5501 | 201.5432 |  28005933 | 16887246784 |    0    |    0.00   |    0     |     0     |  5   |
| 20210526 | 202.4997 | 208.7025 | 200.4800 | 206.3560 |  28639305 | 17668862800 |    0    |    0.00   |    0     |     0     |  2   |
| 20210527 | 206.7260 | 210.3556 | 205.3828 | 210.2623 |  26370593 | 16465448584 |    0    |    0.00   |    0     |     0     |  2   |
| 20210528 | 209.4791 | 211.8421 | 207.4393 | 208.3858 |  22737038 | 14297129584 |    0    |    0.00   |    0     |     0     |  5   |
| 20210601 | 209.2457 | 211.2455 | 206.8293 | 207.9459 |  18084890 | 11327571528 |    0    |    0.00   |    0     |     0     |  5   |
| 20210602 | 206.6893 | 207.7659 | 199.6934 | 201.6865 |  23302779 | 14157803885 |    0    |    0.00   |    0     |     0     |  5   |
| 20210603 | 200.5799 | 201.4965 | 190.3876 | 190.9276 |  30111893 | 17715996811 |    0    |    0.00   |    0     |     0     |  5   |
| 20210604 | 193.2173 | 200.1833 | 192.3808 | 199.6634 |  24036896 | 14302696996 |    0    |    0.00   |    0     |     0     |  2   |
| 20210607 | 197.2553 | 203.3130 | 194.2739 | 201.6898 |  22543682 | 13366856544 |    0    |    0.00   |    0     |     0     |  2   |
| 20210608 | 207.6492 | 207.6759 | 198.4801 | 201.1765 |  26053405 | 15813284073 |    0    |    0.00   |    0     |     0     |  5   |
...
| 20250429 | 285.5000 | 293.3200 | 279.4695 | 292.0300 | 108906553 | 31079741528 |    0    |    0.00   |    0     |     0     |  2   |
| 20250430 | 279.9000 | 284.4500 | 270.7800 | 282.1600 | 128961057 | 35988072639 |    0    |    0.00   |    0     |     0     |  5   |
| 20250501 | 280.0100 | 290.8688 | 279.8100 | 280.5200 |  99658974 | 28346669926 |    0    |    0.00   |    0     |     0     |  5   |
| 20250502 | 284.9000 | 294.7800 | 279.8100 | 287.2100 | 114454683 | 32962705745 |    0    |    0.00   |    0     |     0     |  2   |
| 20250505 | 284.5700 | 284.8490 | 274.4000 | 280.2600 |  94618882 | 26433183690 |    0    |    0.00   |    0     |     0     |  5   |
| 20250506 | 273.1050 | 277.7300 | 271.3500 | 275.3500 |  76715792 | 21057567879 |    0    |    0.00   |    0     |     0     |  5   |
| 20250507 | 276.8800 | 277.9200 | 271.0000 | 276.2200 |  71882408 | 19753805950 |    0    |    0.00   |    0     |     0     |  2   |
| 20250508 | 279.6300 | 289.8000 | 279.4100 | 284.8200 |  97539448 | 27846070698 |    0    |    0.00   |    0     |     0     |  2   |
| 20250509 | 285.5000 | 287.1200 | 284.1000 | 286.9400 |   186979  |   53445380  |    0    |    0.00   |    0     |     0     |  2   |
+----------+----------+----------+----------+----------+-----------+-------------+---------+-----------+----------+-----------+------+
rsp_cd
00000
rsp_msg
조회완료
'''
